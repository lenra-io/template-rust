componentsApi: "1.0"
generator:
  dofigen:
    builders:
    - name: builder
      image: rust
      adds:
      - "."
      script:
      - cargo build --release
      # copy the generated binary outside of the target directory. If not the other stages won't be able to find it since it's in a cache volume
      - mv target/release/app /tmp/
      caches:
      # Cargo cache
      - /home/rust/.cargo
      # build cache
      - /home/rust/src/target
    image: debian:stable-slim
    workdir: /app
    artifacts:
    - builder: builder
      source: "/tmp/app"
      destination: "/app/"
    cmd:
    - /app/app
    ignores:
    - "**"
    - "!/src"
    - "!/Cargo.*"
